# 認証機能の実装

ログイン認証機能の実装ではJWT機能を用いることを考えております。
ユーザー側が登録済みのメールアドレス,パスワードの送信を行った後にサーバー側がユーザー側にトークンの発行を行い、トークンが有効である限りログイン後の操作を可能にする設計を行う予定です。(グーグルログインの操作も同様)

## 技術選定

フロントエンド:Nuxt.js
JWTのトークン情報をVuexライブラリを用いてフロントエンド側で保持させるため。(Next.jsでも代替可)

サーバサイド:Ruby on Rails
JWTのエンコードとデコードを使った認証やGoogleログインにrubyのライブラリを用いるため。
ほかフリマサービスにおける基本的なCRUD機能や決済機能は同フレームワークを用いて実現することが可能。

サーバー構成
AWS(ECS on Fargate)を使用。開発環境をdockerで構築することを前提にイメージベースでデプロイすることを想定。


## 認証機能に関するテーブル設計


### Users

| 列名              | データ型         | 説明                                 |
|------------------|-----------------|-------------------------------------|
| id               | BIGINT          | 主キー         |
| email            | VARCHAR(255)    | ユーザーのメールアドレス、一意     |
| password_digest    | VARCHAR(255)    | ハッシュ化されたパスワード         |
| created_at       | DATETIME        | アカウントの作成日時               |
| updated_at       | DATETIME        | アカウントの最終更新日時           |
| refresh_token       | VARCHAR(255)    | ※1             |
| status           | TINYINT         | アカウントの状態（有効=1, 無効=0）※2|

※1:本認証機能においては保護リソースにアクセスするためのJWT(以降access_tokenと記載)とそれを発行するためのJWT(reflesh_token)の2つを用いる。ログイン後のユーザーはaccess_tokenの期限がある限り保護リソースにアクセスできるが、access_tokenの期限が切れた時にはデータベースに保管されたrefresh_tokenの読み込みを行い、refresh_tokenの期限が切れていなければ新しいaccess_tokenとrefresh_tokenの発行を行う。

| JWT          | 期限     | 保管先    |説明                       |
|------|-------|--------|------------------|
| access_token      | 30分      |Vuex        |保護リソースにアクセスするためのトークン|
| reflesh_token     | 24時間    | クッキー     |access_tokenを発行するためのトークン|

※2ユーザー登録後にメール認証を行い、メール認証が行われたらstatusを有効にする


## 実装フロー

1.テーブル設計に従いマイグレーションファイルの作成とマイグレーションの実行を行う

2.ユーザー登録機能の作成を行い、ユーザーの新規登録ができること、登録後メールアドレスに送信されたリンクからユーザーを有効にできるか確認を行う

3.メールアドレスとパスワードによるログイン機能の実装を行い、access_tokenが有効であれば保護リソースにアクセスができること、access_tokenが無効でもreflesh_tokenが有効であればトークンが再発行されること、reflesh_tokenが無効ならログアウトされることを確認する

4.Googleアカウントによるログイン機能を実装しGoogleアカウントによってログインしても上記と同じ動作になることを確認する

5.単体テスト、結合テストを用意して問題が発生しないこと、CSRF攻撃等の検証を行い、セキュリティ上に問題がないかを確認する