# 学習元サイト(SpecialThanks)

https://sqlab.net/

# 問題文

### 書籍一覧をカテゴリー毎に集計して多い順に、カテゴリー名は昇順に並び替えてください。データの取得件数は先頭から 3 件のみにしてください。出力項目は name(カテゴリー名)と num(書籍数)です。

※ DB: PostgreSQL ver14.4

# SQL

```sql
SELECT
  c.name,
  COUNT(bc.book_id) AS num
FROM
  categories c
LEFT JOIN
  book_categories bc ON c.id = bc.category_id
GROUP BY
  c.id
ORDER BY
  num DESC,
  c.name ASC
LIMIT
  3;
```

# 実行前

## books テーブル

| id  | name                            | release_year | total_page |
| --- | ------------------------------- | ------------ | ---------- |
| 1   | コードと回路                    | 2017         | 245        |
| 2   | 宇宙の歴史                      | 2019         | 314        |
| 3   | 星の記憶                        |              | 181        |
| 4   | リファクタリング                | 2004         | 315        |
| 5   | 時短レシピ 100                  | 2008         | 298        |
| 6   | 世界一周マップ                  | 2005         | 187        |
| 7   | 砂                              |              | 244        |
| 8   | ドン・スターク                  | 2006         | 272        |
| 9   | 投資のススメ                    | 2018         | 350        |
| 10  | 青毛のアン                      | 2009         | 338        |
| 11  | ロザリンのおくりもの            | 2019         | 187        |
| 12  | かもめ飛行                      | 2006         | 307        |
| 13  | 英単語 1000                     | 2010         | 185        |
| 14  | 預言者モネ                      | 2014         | 334        |
| 15  | 人生の歩み方                    | 2008         | 274        |
| 16  | 子育て日記                      | 2009         | 241        |
| 17  | ためになるお金の知識            | 2004         | 326        |
| 18  | SNS マーケティングの基本        | 2018         | 205        |
| 19  | 一軒家かマンションか            | 2005         | 323        |
| 20  | SDGs とは何か                   | 2020         | 197        |
| 21  | 覚えておきたい Excel 手法 50 選 | 2011         | 189        |
| 22  | マネジメントの教本              | 2009         | 220        |
| 23  | デザインの心得                  | 2005         | 322        |
| 24  | コンピューターサイエンス基礎    | 2021         | 216        |
| 25  | マンガで学ぶ日本史              | 2020         | 308        |
| 26  | カエルのぴょこ                  | 2016         | 54         |
| 27  | マンガで学ぶデータベース        | 2019         | 324        |
| 28  | 達人 Ruby on Rails              | 2008         | 295        |
| 29  | 噂のトンネル                    | 2010         | 325        |
| 30  | マンガで学ぶ世界史              | 2020         | 262        |

## categories テーブル

| id  | name                     |
| --- | ------------------------ |
| 1   | 文芸・評論               |
| 2   | サイエンス・テクノロジー |
| 3   | 旅行                     |
| 4   | 歴史・地理               |
| 5   | ビジネス・経済           |
| 6   | 語学                     |
| 7   | 教育・自己啓発           |
| 8   | 暮らし・健康・料理       |
| 9   | 政治・社会               |
| 10  | アート・建築・デザイン   |
| 11  | 絵本・児童書             |
| 12  | 未分類                   |

## book_categories テーブル

| id  | book_id | category_id |
| --- | ------- | ----------- |
| 1   | 1       | 2           |
| 2   | 2       | 2           |
| 3   | 3       | 1           |
| 4   | 4       | 2           |
| 5   | 5       | 8           |
| 6   | 6       | 3           |
| 7   | 7       | 1           |
| 8   | 8       | 12          |
| 9   | 9       | 5           |
| 10  | 10      | 2           |
| 11  | 11      | 2           |
| 12  | 12      | 2           |
| 13  | 13      | 6           |
| 14  | 14      | 12          |
| 15  | 15      | 8           |
| 16  | 16      | 8           |
| 17  | 17      | 5           |
| 18  | 18      | 5           |
| 19  | 19      | 8           |
| 20  | 20      | 9           |
| 21  | 21      | 2           |
| 22  | 22      | 7           |
| 23  | 23      | 10          |
| 24  | 24      | 2           |
| 25  | 25      | 4           |
| 26  | 25      | 7           |
| 27  | 26      | 11          |
| 28  | 27      | 2           |
| 29  | 28      | 2           |
| 30  | 29      | 1           |
| 31  | 30      | 4           |
| 32  | 30      | 7           |

# 実行後

| name                     | num |
| ------------------------ | --- |
| サイエンス・テクノロジー | 10  |
| 暮らし・健康・料理       | 4   |
| ビジネス・経済           | 3   |

# 備考

SQL は一般的に以下の順番で行われる

1. FROM
2. JOIN
3. WHERE
4. GROUP BY
5. AGGREGATE FUNCTIONS (COUNT(), SUM(), etc.) (※集計関数のこと)
6. HAVING
7. SELECT
8. DISTINCT
9. ORDER BY
10. LIMIT

以下に本 SQL で順番に行われた処理をまとめる

## 1.categories テーブルに対して book_categories テーブルを結合

categories の id と book_categories の category_id を紐づけて
２つのテーブルのカラムをまとめて 1 つのテーブルにする
(categories が左に位置するが id は book_categories を基準に充てられる)

```sql
SELECT
*
FROM
  categories c
LEFT JOIN
  book_categories bc ON c.id = bc.category_id
```

| id  | name                     | id  | book_id | category_id |
| --- | ------------------------ | --- | ------- | ----------- |
| 2   | サイエンス・テクノロジー | 1   | 1       | 2           |
| 2   | サイエンス・テクノロジー | 2   | 2       | 2           |
| 1   | 文芸・評論               | 3   | 3       | 1           |
| 2   | サイエンス・テクノロジー | 4   | 4       | 2           |
| 8   | 暮らし・健康・料理       | 5   | 5       | 8           |
| 3   | 旅行                     | 6   | 6       | 3           |
| 1   | 文芸・評論               | 7   | 7       | 1           |
| 12  | 未分類                   | 8   | 8       | 12          |
| 5   | ビジネス・経済           | 9   | 9       | 5           |
| 2   | サイエンス・テクノロジー | 10  | 10      | 2           |
| 2   | サイエンス・テクノロジー | 11  | 11      | 2           |
| 2   | サイエンス・テクノロジー | 12  | 12      | 2           |
| 6   | 語学                     | 13  | 13      | 6           |
| 12  | 未分類                   | 14  | 14      | 12          |
| 8   | 暮らし・健康・料理       | 15  | 15      | 8           |
| 8   | 暮らし・健康・料理       | 16  | 16      | 8           |
| 5   | ビジネス・経済           | 17  | 17      | 5           |
| 5   | ビジネス・経済           | 18  | 18      | 5           |
| 8   | 暮らし・健康・料理       | 19  | 19      | 8           |
| 9   | 政治・社会               | 20  | 20      | 9           |
| 2   | サイエンス・テクノロジー | 21  | 21      | 2           |
| 7   | 教育・自己啓発           | 22  | 22      | 7           |
| 10  | アート・建築・デザイン   | 23  | 23      | 10          |
| 2   | サイエンス・テクノロジー | 24  | 24      | 2           |
| 4   | 歴史・地理               | 25  | 25      | 4           |
| 7   | 教育・自己啓発           | 26  | 25      | 7           |
| 11  | 絵本・児童書             | 27  | 26      | 11          |
| 2   | サイエンス・テクノロジー | 28  | 27      | 2           |
| 2   | サイエンス・テクノロジー | 29  | 28      | 2           |
| 1   | 文芸・評論               | 30  | 29      | 1           |
| 4   | 歴史・地理               | 31  | 30      | 4           |
| 7   | 教育・自己啓発           | 32  | 30      | 7           |

※categories テーブルが基準になると言われてるので上の並び方は間違っているかも。

## 2.categories.id に基づいてグループ化

```sql
SELECT
c.id,
c.name
FROM
categories c
LEFT JOIN
book_categories bc ON c.id = bc.category_id
GROUP BY
c.id
```

※SELECT \*は使えなかったので c.id,c.name を対象にしている

| id  | name                     |
| --- | ------------------------ |
| 12  | 未分類                   |
| 3   | 旅行                     |
| 11  | 絵本・児童書             |
| 8   | 暮らし・健康・料理       |
| 10  | アート・建築・デザイン   |
| 7   | 教育・自己啓発           |
| 9   | 政治・社会               |
| 1   | 文芸・評論               |
| 5   | ビジネス・経済           |
| 4   | 歴史・地理               |
| 2   | サイエンス・テクノロジー |
| 6   | 語学                     |

## 3.グループに含まれた bc.book_id の数をカウントする

AS 句でカラム名を num としている

```sql
SELECT
c.name,
  COUNT(bc.book_id) AS num
FROM
  categories c
LEFT JOIN
  book_categories bc ON c.id = bc.category_id
GROUP BY
  c.id
```

| name                     | num |
| ------------------------ | --- |
| 未分類                   | 2   |
| 旅行                     | 1   |
| 絵本・児童書             | 1   |
| 暮らし・健康・料理       | 4   |
| アート・建築・デザイン   | 1   |
| 教育・自己啓発           | 3   |
| 政治・社会               | 1   |
| 文芸・評論               | 3   |
| ビジネス・経済           | 3   |
| 歴史・地理               | 2   |
| サイエンス・テクノロジー | 10  |
| 語学                     | 1   |

## 4.SELECT で実際に出力する列を決定する

上のデータが該当するのでここでは割愛

## 5.書籍数の多い順に、次にカテゴリー名の昇順に並び変える

```sql
SELECT
  c.name,
  COUNT(bc.book_id) AS num
FROM
  categories c
LEFT JOIN
  book_categories bc ON c.id = bc.category_id
GROUP BY
  c.id
ORDER BY
  num DESC,
  c.name ASC
```

| name                     | num |
| ------------------------ | --- |
| サイエンス・テクノロジー | 10  |
| 暮らし・健康・料理       | 4   |
| ビジネス・経済           | 3   |
| 教育・自己啓発           | 3   |
| 文芸・評論               | 3   |
| 未分類                   | 2   |
| 歴史・地理               | 2   |
| アート・建築・デザイン   | 1   |
| 政治・社会               | 1   |
| 旅行                     | 1   |
| 絵本・児童書             | 1   |
| 語学                     | 1   |

## 6. 結果セットの上位から指定された数の行(3 行)だけを返す

```sql
SELECT
  c.name,
  COUNT(bc.book_id) AS num
FROM
  categories c
LEFT JOIN
  book_categories bc ON c.id = bc.category_id
GROUP BY
  c.id
ORDER BY
  num DESC,
  c.name ASC
LIMIT
  3;
```

| name                     | num |
| ------------------------ | --- |
| サイエンス・テクノロジー | 10  |
| 暮らし・健康・料理       | 4   |
| ビジネス・経済           | 3   |
